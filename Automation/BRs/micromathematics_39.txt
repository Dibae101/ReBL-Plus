Title: NumberFormatException when parsing very large number in "Significant digits in result" field

App: microMathematics Plus
Package Name: com.mkulesh.micromath.plus
Issue: https://github.com/mkulesh/microMathematics/issues/39

Description:
microMathematics Plus crashes with a NumberFormatException when a user enters a very large number in the "Significant digits in result" field in the Document Settings dialog and then presses the "+" button. The app attempts to parse this large number as an integer using Integer.parseInt(), but the number exceeds the maximum value for a 32-bit integer (2,147,483,647), causing the parsing to fail. The crash occurs because the code doesn't validate that the input value is within the valid integer range before attempting to parse it.

Root Cause:
The HorizontalNumberPicker widget's onClick() method attempts to parse the text field value directly using Integer.valueOf() without checking if the number is within the valid integer range. When users enter extremely large numbers (like 123456789012 or 1274375155085100044673746644154457), these exceed Integer.MAX_VALUE (2^31 - 1 = 2,147,483,647) and cause a NumberFormatException.

The problematic code in HorizontalNumberPicker.java line 111:
```java
@Override
public void onClick(View v) {
    String currentValue = editText.getText().toString();
    
    // PROBLEM: No validation before parsing
    int value = Integer.valueOf(currentValue); // CRASH if value > Integer.MAX_VALUE
    
    if (v == plusButton) {
        value++;
    } else if (v == minusButton) {
        value--;
    }
    
    editText.setText(String.valueOf(value));
}
```

The integer range limits:
- Minimum: -2,147,483,648 (Integer.MIN_VALUE)
- Maximum: 2,147,483,647 (Integer.MAX_VALUE)

Any number outside this range causes NumberFormatException when parsing with Integer.parseInt() or Integer.valueOf().

Steps to Reproduce:
1. Launch microMathematics Plus app
2. Open the "Document settings" dialog from the menu
3. Navigate to the "Significant digits in result" field
4. Enter a very large number that exceeds integer range: `123456789012`
   - Or any number > 2,147,483,647
5. Press the "+" button on the right side of this field
6. Observe the app crashes immediately with NumberFormatException

Alternative reproduction:
- Enter: `1274375155085100044673746644154457` (extremely large number)
- Press "+" or "-" button
- App crashes

Expected Behavior:
- When a number exceeds the maximum allowed value, the field should:
  - Be automatically capped at the maximum valid value (e.g., 15 or 20 for significant digits)
  - Display an error message: "Value too large, maximum is [MAX]"
  - Prevent the "+" button from increasing beyond maximum
- No crash should occur for any user input
- Input validation should enforce reasonable bounds for significant digits (typically 1-15)

Actual Behavior:
- App crashes immediately when pressing "+" or "-" with a large number
- NumberFormatException is thrown
- No error message or validation
- User loses current work in the app
- No recovery without restarting the app

Crash Details:
```
java.lang.NumberFormatException: Invalid int: "1274375155085100044673746644154457"
    at java.lang.Integer.invalidInt(Integer.java:138)
    at java.lang.Integer.parse(Integer.java:413)
    at java.lang.Integer.parseInt(Integer.java:367)
    at java.lang.Integer.parseInt(Integer.java:334)
    at java.lang.Integer.valueOf(Integer.java:525)
    at com.mkulesh.micromath.widgets.HorizontalNumberPicker.onClick(HorizontalNumberPicker.java:111)
    at android.view.View.performClick(View.java:5198)
    at android.view.View$PerformClick.run(View.java:21147)
    at android.os.Handler.handleCallback(Handler.java:739)
    at android.os.Handler.dispatchMessage(Handler.java:95)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5417)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:726)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:616)
```

- Exception Type: NumberFormatException
- Error Message: "Invalid int: [very large number]"
- Location: HorizontalNumberPicker.java line 111 (onClick method)
- Trigger: Pressing "+" or "-" button with number > Integer.MAX_VALUE
- Reported Date: November 2, 2017
- Reporter: tianxiaogu
- Device: Android 6.0 emulator (generic_x86)
- Status: Fixed in v2.15.5 (November 20, 2017)
- Frequency: 100% with numbers exceeding integer range

Technical Analysis:

**Integer Overflow and Range Limits**:
Java's `int` type is a 32-bit signed integer with range:
- Minimum: -2,147,483,648 (0x80000000)
- Maximum: 2,147,483,647 (0x7FFFFFFF)

Numbers outside this range cannot be represented as `int` and cause NumberFormatException.

**The Problem with Direct Parsing**:
```java
// These will crash:
int value = Integer.parseInt("123456789012");        // > MAX_VALUE
int value = Integer.valueOf("1274375155085100044673746644154457"); // Way too large
int value = Integer.parseInt("-3000000000");         // < MIN_VALUE
```

**Solution Approaches**:

1. **Use Try-Catch Block (Initial Fix)**:
```java
@Override
public void onClick(View v) {
    String currentValue = editText.getText().toString();
    
    try {
        int value = Integer.valueOf(currentValue);
        
        if (v == plusButton) {
            value++;
        } else if (v == minusButton) {
            value--;
        }
        
        // Enforce maximum/minimum bounds
        value = Math.max(minValue, Math.min(maxValue, value));
        editText.setText(String.valueOf(value));
        
    } catch (NumberFormatException e) {
        // Reset to maximum allowed value
        editText.setText(String.valueOf(maxValue));
    }
}
```

2. **Pre-validate Before Parsing**:
```java
public int getValue() {
    String text = editText.getText().toString().trim();
    
    if (text.isEmpty()) {
        return minValue;
    }
    
    try {
        // Use Long to check if it fits in int range
        long longValue = Long.parseLong(text);
        
        if (longValue > Integer.MAX_VALUE) {
            return maxValue;
        } else if (longValue < Integer.MIN_VALUE) {
            return minValue;
        }
        
        return (int) longValue;
        
    } catch (NumberFormatException e) {
        // Not a valid number at all
        return minValue;
    }
}
```

3. **Input Filtering (Prevention)**:
```java
// Restrict input to valid range using InputFilter
editText.setFilters(new InputFilter[]{
    new InputFilter.LengthFilter(10), // Max 10 digits
    new InputFilter() {
        @Override
        public CharSequence filter(CharSequence source, int start, int end,
                                   Spanned dest, int dstart, int dend) {
            try {
                String newText = dest.toString().substring(0, dstart)
                               + source.subSequence(start, end)
                               + dest.toString().substring(dend);
                long value = Long.parseLong(newText);
                if (value >= Integer.MIN_VALUE && value <= Integer.MAX_VALUE) {
                    return null; // Accept input
                }
            } catch (NumberFormatException e) {
                // Reject non-numeric input
            }
            return ""; // Reject input
        }
    }
});
```

**Additional Issue in getValue() Method**:
The reporter (tianxiaogu) noted that the getValue() method also needed a try-catch block. This suggests similar parsing was done when reading the value:

```java
// Also needs protection
public int getValue() {
    try {
        return Integer.valueOf(editText.getText().toString());
    } catch (NumberFormatException e) {
        return defaultValue; // Return safe default
    }
}
```

Impact:
- Severity: Medium - Crashes app but requires specific user action
- Frequency: Low-Medium (users must intentionally enter large numbers)
- Affected Component: HorizontalNumberPicker widget, Document Settings dialog
- User Impact: App crash when entering large numbers, loses current work
- Affected Feature: Significant digits configuration (typically should be 1-15)
- Workaround: Only enter numbers within valid integer range (< 2,147,483,647)

Use Case Context:
microMathematics Plus is a scientific calculator and formula visualization app for Android. The "Significant digits in result" setting controls the precision of calculation results. Realistically, this value should be bounded to a small range (like 1-15 or 1-20), as more than 15 significant digits is rarely meaningful in floating-point calculations. Users might accidentally enter large numbers through copy-paste or by typing many digits.

Resolution:
Fixed by mkulesh in two commits:
1. **First fix (November 7, 2017)**: Commit ea9be06 - Added try-catch in onClick()
2. **Second fix (November 9, 2017)**: Commit 7f1f669 - Added try-catch in getValue()
3. **Released in v2.15.5** (November 20, 2017)

The fix progression:
1. Initial fix added error handling to onClick() method
2. Reporter identified getValue() also needed protection
3. Complete fix added try-catch blocks to both methods
4. Value is now capped at maximum allowed value instead of crashing

File Modified:
- com/mkulesh/micromath/widgets/HorizontalNumberPicker.java

Fix Implementation:
```java
// onClick method - wrap parsing in try-catch
@Override
public void onClick(View v) {
    try {
        int value = Integer.valueOf(editText.getText().toString());
        // ... increment/decrement logic ...
        // Clamp to valid range
        value = Math.max(minValue, Math.min(maxValue, value));
        editText.setText(String.valueOf(value));
    } catch (NumberFormatException e) {
        // Set to maximum allowed value
        editText.setText(String.valueOf(maxValue));
    }
}

// getValue method - also needs try-catch
public int getValue() {
    try {
        int value = Integer.valueOf(editText.getText().toString());
        return Math.max(minValue, Math.min(maxValue, value));
    } catch (NumberFormatException e) {
        return defaultValue;
    }
}
```

Best Practices:
1. **Always validate user input** before parsing to primitive types
2. **Use try-catch** for parsing operations that can fail
3. **Set reasonable bounds** for numeric inputs (min/max values)
4. **Use input filters** to prevent invalid input at the UI level
5. **Provide clear error messages** instead of crashing
6. **Consider using Long** for intermediate parsing to detect overflow
7. **Test with edge cases**: empty strings, very large numbers, negative numbers
8. **Enforce domain-specific constraints** (e.g., significant digits should be 1-15)

Alternative Data Types:
- Use `Long.parseLong()` if larger numbers needed
- Use `BigInteger` for arbitrary-precision integers
- Use `Double.parseDouble()` for decimal numbers
- Check ranges before downcasting from long to int

Testing Edge Cases:
```java
// Test cases for number picker:
"" (empty)                          // Should return default
"0"                                 // Valid
"15"                                // Valid for significant digits
"2147483647"                        // MAX_VALUE - valid
"2147483648"                        // MAX_VALUE + 1 - should cap
"123456789012"                      // Much larger - should cap
"-1"                                // Possibly invalid for significant digits
"abc"                               // Not a number - should handle
```

Lessons Learned:
- User input can never be trusted to be within valid ranges
- Defensive programming requires error handling for all parsing operations
- Multiple code paths may have the same vulnerability (onClick and getValue)
- Testing with extreme values reveals input validation bugs
- Good bug reporters help identify all instances of a problem

Note: microMathematics is an open-source scientific calculator app with powerful formula visualization capabilities. It's particularly popular among students and engineers for its ability to write and solve mathematical expressions in a natural format similar to textbook notation.
